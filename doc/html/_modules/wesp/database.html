

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>wesp.database &mdash; wesp 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> wesp
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../wesp.html">wesp package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wesp</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>wesp.database</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for wesp.database</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="kn">from</span> <span class="nn">mysql.connector</span> <span class="k">import</span> <span class="n">errorcode</span>
<span class="kn">from</span> <span class="nn">mysql.connector.errors</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">from</span> <span class="nn">wesp.definitions</span> <span class="k">import</span> <span class="n">AllParameter</span>


<div class="viewcode-block" id="Database"><a class="viewcode-back" href="../../wesp.database.html#wesp.database.Database">[docs]</a><span class="k">class</span> <span class="nc">Database</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains all functions related to the database. To ensure that only one database connection is used, everything</span>
<span class="sd">    in this class is static.</span>

<span class="sd">    The different raw statements are completed in the</span>
<span class="sd">    :meth:`init_database` using the data inside of :class:`wesp.definitions.AllParameter`.</span>

<span class="sd">    The function :meth:`_create_database_and_table_if_not_existing` will check if the database and the table exist,</span>
<span class="sd">    otherwise it will create it using the *databaseCreateStatement*.</span>

<span class="sd">    The function :meth:`_check_if_columns_exist`  will check if all columns exists and have the right data type.</span>

<span class="sd">    Data can be inserted using the function :meth:`insert_data_set`. This function expects the data to be in the</span>
<span class="sd">    format of the dict *CLIENT_DATA* inside the :mod:`cli_parser` module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">databaseCreateStatement</span> <span class="o">=</span> <span class="s2">&quot;CREATE DATABASE IF NOT EXISTS </span><span class="si">%%</span><span class="s2">DATABASE</span><span class="si">%%</span><span class="s2">;&quot;</span>
    <span class="sd">&quot;&quot;&quot;This statement will be used to create the database. It will only trigger if the database does </span>
<span class="sd">    not exists. Note the name of the database will be inserted in the :meth:`init_database` function.&quot;&quot;&quot;</span>

    <span class="n">tableCreateStatement</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS </span><span class="si">%%</span><span class="s2">DATABASE</span><span class="si">%%</span><span class="s2">.</span><span class="si">%%</span><span class="s2">TABLE</span><span class="si">%%</span><span class="s2"> (</span>
<span class="s2">    `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span>
<span class="s2">      `Timestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span>
<span class="s2">      </span><span class="si">%%</span><span class="s2">PARAMETER</span><span class="si">%%</span><span class="s2"></span>
<span class="s2">      PRIMARY KEY (`id`),</span>
<span class="s2">      KEY `ipIndex` (`</span><span class="si">%%</span><span class="s2">IP_INDEX</span><span class="si">%%</span><span class="s2">`),</span>
<span class="s2">      KEY `macIndex` (`</span><span class="si">%%</span><span class="s2">MAC_INDEX</span><span class="si">%%</span><span class="s2">`)</span>
<span class="s2">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;&quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;This statement creates the table. It will only trigger if the database does </span>
<span class="sd">    not exists. Note the name of the database and table, as well as all other fields (based on </span>
<span class="sd">    registered parameters in :class:`wesp.definitions.AllParameter`) will be inserted in the :meth:`init_database` </span>
<span class="sd">    function. The generation of that data is done in the</span>
<span class="sd">    :meth:`wesp.helper.generate_parameter_create_statement` function but has to be ran by the caller of </span>
<span class="sd">    the :meth:`init_database` function.&quot;&quot;&quot;</span>

    <span class="n">insertStatement</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO </span><span class="si">%%</span><span class="s2">TABLE</span><span class="si">%%</span><span class="s2"> </span><span class="si">%%</span><span class="s2">PARAMETER</span><span class="si">%%</span><span class="s2">;&quot;&quot;&quot;</span><span class="p">;</span>
    <span class="sd">&quot;&quot;&quot;This statement is used to insert data. The names and a list of parameters are</span>
<span class="sd">    inserted in the function :meth:`init_database`. The corresponding values are inserted </span>
<span class="sd">    in the :meth:`insert_data_set` function.</span>
<span class="sd">    The generation of that substring is done in the </span>
<span class="sd">    :meth:`wesp.helper.generate_parameter_insert_statement` function but has to be ran by the caller of </span>
<span class="sd">    the :meth:`init_database` function.&quot;&quot;&quot;</span>

    <span class="n">column_total_check</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM information_schema.COLUMNS WHERE TABLE_SCHEMA like &#39;</span><span class="si">%%</span><span class="s2">DATABASE</span><span class="si">%%</span><span class="s2">&#39; </span>
<span class="s2">    AND TABLE_NAME like &#39;</span><span class="si">%%</span><span class="s2">TABLE</span><span class="si">%%</span><span class="s2">&#39; AND COLUMN_NAME like &#39;</span><span class="si">%%</span><span class="s2">COLUMN</span><span class="si">%%</span><span class="s2">&#39; AND COLUMN_TYPE like &#39;</span><span class="si">%%</span><span class="s2">DATA_TYPE</span><span class="si">%%</span><span class="s2">&#39;&quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This statement is used to check if a column exists. Here the name and the data type is checked. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">column_only_name_check</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM information_schema.COLUMNS WHERE TABLE_SCHEMA like &#39;</span><span class="si">%%</span><span class="s2">DATABASE</span><span class="si">%%</span><span class="s2">&#39; </span>
<span class="s2">        AND TABLE_NAME like &#39;</span><span class="si">%%</span><span class="s2">TABLE</span><span class="si">%%</span><span class="s2">&#39; AND COLUMN_NAME like &#39;</span><span class="si">%%</span><span class="s2">COLUMN</span><span class="si">%%</span><span class="s2">&#39;&quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This statement is used to check if a column exists. Here only the name is checked. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">create_new_column</span> <span class="o">=</span> <span class="s2">&quot;ALTER TABLE </span><span class="si">%%</span><span class="s2">DATABASE</span><span class="si">%%</span><span class="s2">.</span><span class="si">%%</span><span class="s2">TABLE</span><span class="si">%%</span><span class="s2"> ADD COLUMN `</span><span class="si">%%</span><span class="s2">COLUMN</span><span class="si">%%</span><span class="s2">` </span><span class="si">%%</span><span class="s2">DATA_TYPE</span><span class="si">%%</span><span class="s2">; &quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This statement will created a new column in a existing table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">modify_column</span> <span class="o">=</span> <span class="s2">&quot;ALTER TABLE </span><span class="si">%%</span><span class="s2">DATABASE</span><span class="si">%%</span><span class="s2">.</span><span class="si">%%</span><span class="s2">TABLE</span><span class="si">%%</span><span class="s2"> MODIFY COLUMN `</span><span class="si">%%</span><span class="s2">COLUMN</span><span class="si">%%</span><span class="s2">` </span><span class="si">%%</span><span class="s2">DATA_TYPE</span><span class="si">%%</span><span class="s2">; &quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This statement will modify the data type of an column to match the one registered in this program</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">global_config</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Database.init_database"><a class="viewcode-back" href="../../wesp.database.html#wesp.database.Database.init_database">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_database</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">parameter_create</span><span class="p">,</span> <span class="n">parameter_insert</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Will initialize the database and complete the SQL Statements with the given names and sub-statements</span>

<span class="sd">        :param ctx: current Context</span>
<span class="sd">        :param config: config for database connection, can be generated using :meth:`wesp.helper.generate_db_conf_from_context`</span>
<span class="sd">        :param parameter_create: parameter part of create statement, can be generated using :meth:`wesp.helper.generate_parameter_create_statement`</span>
<span class="sd">        :param parameter_insert: parameter part of insert statement, can be generated using :meth:`wesp.helper.generate_parameter_insert_statement`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;db_table&#39;</span><span class="p">]</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">db_name</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]</span>

        <span class="c1"># add given names to SQL statements</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">databaseCreateStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">databaseCreateStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATABASE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATABASE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>

        <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">TABLE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">insertStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">insertStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">TABLE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>

        <span class="c1"># add the parameters create statement into the tableCreateStatement</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">PARAMETER</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter_create</span><span class="p">)</span>

        <span class="c1"># add the human readable as well as their program name into the insert statement</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">insertStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">insertStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">PARAMETER</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter_insert</span><span class="p">)</span>

        <span class="c1"># add names for the indices</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">IP_INDEX</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span>
                                                                              <span class="n">AllParameter</span><span class="o">.</span><span class="n">client_ip</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">MAC_INDEX</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span>
                                                                              <span class="n">AllParameter</span><span class="o">.</span><span class="n">client_mac</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># add the database config to the class</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">global_config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="n">Database</span><span class="o">.</span><span class="n">_create_database_and_table_if_not_existing</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">Database</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_database_and_table_if_not_existing</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Will check the existence of the database and table with the names specified in the :meth:`init_database`</span>
<span class="sd">        function. If they do not exist they will be created.</span>
<span class="sd">        Therefore a connection to the database *Information_Schema* is performed.</span>

<span class="sd">        :param config: config for database connection, can be generated by :meth:`wesp.helper.generate_db_conf_from_context`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># copy dict to prevent changes in original config</span>
        <span class="n">config_information_schema</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># change to Information Schema DB in case WESP does not exist</span>
        <span class="n">config_information_schema</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;INFORMATION_SCHEMA&quot;</span>

        <span class="n">cnx</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnx</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">config_information_schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;MySQL Error: Something is wrong with your user name or password&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;MySQL Error: Database INFORMATION_SCHEMA does not exist. Check your MySQL installation.&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;Unknown MySQL Error at initial connection: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">buffered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Create database, if not existing</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">databaseCreateStatement</span><span class="p">)</span>

            <span class="c1"># Create table if not existing</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">tableCreateStatement</span><span class="p">)</span>

            <span class="c1"># Make sure all columns exist and have the right data type</span>
            <span class="n">Database</span><span class="o">.</span><span class="n">_check_if_columns_exist</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>

            <span class="c1"># Make sure data is committed to the database</span>
            <span class="n">cnx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cnx</span><span class="p">:</span>
                <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_if_columns_exist</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Will check if all columns exists and have the right data type. This makes sure that the database always reflects</span>
<span class="sd">        the definition of this program. A column is checked in two ways. First a name and a data type check is performed.</span>
<span class="sd">        Should this fail, it is checked if a column with the same name exists, if so the data type will be modified. If</span>
<span class="sd">        no column exists it will be created.</span>

<span class="sd">        :param cur: cursor from current DB connection</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add database and table name to SQL statements</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">column_only_name_check</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">column_only_name_check</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATABASE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">TABLE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">column_total_check</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">column_total_check</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATABASE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">TABLE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">create_new_column</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">create_new_column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATABASE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">TABLE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">Database</span><span class="o">.</span><span class="n">modify_column</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">modify_column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATABASE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">TABLE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Database</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>

        <span class="c1"># for all parameter which have a data type check if the corresponding column exist</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">AllParameter</span><span class="o">.</span><span class="n">get_all_parameter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">db_data_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># check if column with right name and data type exists</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">column_total_check</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">COLUMN</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATA_TYPE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">db_data_type</span><span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

                <span class="c1"># rowcount of zero means no columns with this name and data type exists</span>
                <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="c1"># check if column only with right name exists, if so modify data type</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">column_only_name_check</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">COLUMN</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

                    <span class="c1"># rowcount of zero means no columns with this name exists</span>
                    <span class="c1"># above zero means that a column has been found with the name</span>
                    <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="c1"># column has to be created</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">create_new_column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">COLUMN</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATA_TYPE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">db_data_type</span><span class="p">)</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># column has to be modified</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">modify_column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">COLUMN</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">DATA_TYPE</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">db_data_type</span><span class="p">)</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<div class="viewcode-block" id="Database.insert_data_set"><a class="viewcode-back" href="../../wesp.database.html#wesp.database.Database.insert_data_set">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">insert_data_set</span><span class="p">(</span><span class="n">data_set</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Will insert the given data into the database based on the config</span>
<span class="sd">        and statement from the :meth:`init_database` function.</span>

<span class="sd">        :param data_set: data set to be inserted, must contain the same fields names as defined in the *insertStatement*</span>
<span class="sd">        :param ctx: current context</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Temporary add client_ip, client_mac and timestamp(which should not be represented in client_data</span>
        <span class="c1"># to prevent output to CLI)</span>
        <span class="c1"># convert timestamp to a format that is understood by the DB</span>
        <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_set</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;client_ip&#39;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;client_ip&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;client_mac&#39;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;client_mac&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)})</span>

        <span class="n">cnx</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnx</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">Database</span><span class="o">.</span><span class="n">global_config</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_ACCESS_DENIED_ERROR</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;MySQL Error: Something is wrong with your user name or password&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;MySQL Error: Database&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;does not exist. Check your MySQL installation.&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;Unknown MySQL Error at insert connection: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">err</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Insert new data set</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">insertStatement</span><span class="p">,</span> <span class="n">data_set</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;SQL error: `</span><span class="si">%s</span><span class="s2">` &quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(If new field has been added, drop the table or add it manually to the table)&quot;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">DataError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">,</span> <span class="n">InternalError</span><span class="p">,</span>
                    <span class="n">MySQLFabricError</span><span class="p">,</span> <span class="n">NotSupportedError</span><span class="p">,</span> <span class="n">OperationalError</span><span class="p">,</span> <span class="n">PoolError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;Unknown SQL error at insert: `</span><span class="si">%s</span><span class="s2">` &quot;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">)</span>

            <span class="c1"># Commit data to the database</span>
            <span class="n">cnx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cnx</span><span class="p">:</span>
                <span class="n">cnx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Database.is_ready"><a class="viewcode-back" href="../../wesp.database.html#wesp.database.Database.is_ready">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_ready</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Will check, if the database connection is ready, which means that the config has been set and the raw</span>
<span class="sd">        statements have been initialized.</span>

<span class="sd">        :return: True if database has been initialized, otherwise False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Database</span><span class="o">.</span><span class="n">ready</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Marcel Rummens and Maximilian Tichter.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>